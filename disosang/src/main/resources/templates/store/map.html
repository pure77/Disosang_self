<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>가맹점 지도 검색</title>
    <script type="text/javascript"
            th:src="'//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoKey} + '&libraries=services'">
    </script>

    #map {width: 100%; height: 500px;}
        .store-list {margin-top: 20px;}
        .store-item {padding: 5px; border-bottom: 1px solid #ddd;}
    </style>
</head>
<body>
<h2>가맹점 지도 검색</h2>

<form id="searchForm">
    <input type="text" id="keyword" placeholder="검색어 입력" required>
    <button type="submit">검색</button>
</form>

<div id="map"></div>

<div class="store-list">
    <h3>검색 결과</h3>
    <div id="storeList"></div>
</div>

<script>
    var mapContainer = document.getElementById('map');
    var mapOption = {
        center: new kakao.maps.LatLng(37.5, 127.0),
        level: 5
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var markers = [];

    // 폼 제출 시 REST API 호출
    document.getElementById('searchForm').addEventListener('submit', function (e) {
        e.preventDefault();

        var bounds = map.getBounds();
        var sw = bounds.getSouthWest();
        var ne = bounds.getNorthEast();
        var center = map.getCenter();

        var params = new URLSearchParams({
            keyword: document.getElementById('keyword').value,
            centerX: center.getLng(),
            centerY: center.getLat(),
            minX: sw.getLng(),
            minY: sw.getLat(),
            maxX: ne.getLng(),
            maxY: ne.getLat()
        });

        fetch('/store/map/search?' + params.toString())
            .then(response => response.json())
            .then(data => {
                showStores(data);
            });
    });

    function showStores(stores) {
        // 이전 마커 제거
        markers.forEach(m => m.setMap(null));
        markers = [];

        var listDiv = document.getElementById('storeList');
        listDiv.innerHTML = '';

        stores.forEach(store => {
            // 마커 생성
            var marker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(store.latitude, store.longitude)
            });
            markers.push(marker);

            var infowindow = new kakao.maps.InfoWindow({
                content: '<div style="padding:5px;">' + store.storeName + '</div>'
            });
            kakao.maps.event.addListener(marker, 'click', function () {
                infowindow.open(map, marker);
            });

            // 리스트에 추가
            var item = document.createElement('div');
            item.className = 'store-item';
            item.innerText = store.storeName + ' | ' + store.address;
            listDiv.appendChild(item);
        });
    }
</script>
</body>
</html>
